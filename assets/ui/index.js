/**
 * Storybook UI - Main Application Script
 * Bundles all components and adds interactive functionality
 */

import { TypeCard } from './components/type-card.js';
import { TypeHierarchy } from './components/type-hierarchy.js';

class StorybookApp {
  constructor(data, containerId = 'app') {
    this.data = data;
    this.container = document.getElementById(containerId);
    this.searchInput = null;
    this.typeCards = [];

    if (!this.container) {
      console.error(`Container #${containerId} not found`);
      return;
    }

    this.init();
  }

  init() {
    this.loadCSS();
    this.renderHeader();
    this.renderSearch();
    this.renderHierarchy();
    this.renderTypes();
    this.renderFooter();
    this.setupEventListeners();
  }

  loadCSS() {
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'styles/main.css';
    document.head.appendChild(link);
  }

  renderHeader() {
    const header = document.createElement('header');
    header.className = 'sb-header';
    header.innerHTML = `
      <h1>TypeScript Interface Documentation</h1>
      <p>Generated from API response â€¢ ${new Date().toISOString()}</p>
    `;
    this.container.appendChild(header);
  }

  renderSearch() {
    const searchContainer = document.createElement('div');
    searchContainer.className = 'sb-search-container';
    this.searchInput = document.createElement('input');
    this.searchInput.type = 'text';
    this.searchInput.className = 'sb-search';
    this.searchInput.placeholder = 'Search types by name, property, or description...';
    searchContainer.appendChild(this.searchInput);
    this.container.appendChild(searchContainer);
  }

  renderHierarchy() {
    const hierarchy = new TypeHierarchy(this.data.types || this.data);
    const nav = document.createElement('nav');
    nav.innerHTML = hierarchy.render();
    this.container.appendChild(nav);
  }

  renderTypes() {
    const main = document.createElement('main');
    main.id = 'type-cards';

    const types = this.data.types || this.data;
    types.forEach(type => {
      const card = new TypeCard(type);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = card.render();
      main.appendChild(wrapper.firstElementChild);
      this.typeCards.push(wrapper.firstElementChild);
    });

    this.container.appendChild(main);
  }

  renderFooter() {
    const footer = document.createElement('footer');
    footer.className = 'sb-footer';
    footer.innerHTML = `
      <p>Generated by api-to-ts-interface skill</p>
      <p><a href="README.md" target="_blank">View Documentation</a></p>
    `;
    this.container.appendChild(footer);
  }

  setupEventListeners() {
    // Search functionality
    if (this.searchInput) {
      this.searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        this.filterTypes(query);
      });
    }

    // Scroll to type on hierarchy click
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('sb-type-link')) {
        e.preventDefault();
        const typeName = e.target.dataset.type;
        this.scrollToType(typeName);
      }
    });
  }

  filterTypes(query) {
    this.typeCards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  }

  scrollToType(typeName) {
    const targetCard = this.typeCards.find(card => {
      const name = card.querySelector('.sb-type-name');
      return name && name.textContent === typeName;
    });

    if (targetCard) {
      targetCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      targetCard.style.boxShadow = '0 0 0 3px rgba(59, 130, 246, 0.5)';
      setTimeout(() => {
        targetCard.style.boxShadow = '';
      }, 2000);
    }
  }
}

// Global helper for copy buttons
window.copyToClipboard = function(button) {
  const pre = button.previousElementSibling;
  if (pre && pre.tagName === 'PRE') {
    const text = pre.textContent;
    navigator.clipboard.writeText(text).then(() => {
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.style.backgroundColor = '#10b981';
      setTimeout(() => {
        button.textContent = originalText;
        button.style.backgroundColor = '';
      }, 2000);
    }).catch(err => {
      console.error('Copy failed:', err);
      button.textContent = 'Error';
    });
  }
};

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  // Storybook data should be loaded into window.__STORYBOOK_DATA__
  if (window.__STORYBOOK_DATA__) {
    new StorybookApp(window.__STORYBOOK_DATA__, 'app');
  }
});

export { StorybookApp };
